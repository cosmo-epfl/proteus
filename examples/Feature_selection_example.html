<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using feature selection to build an efficient potential &mdash; Rascal 0.0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/rascal.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Optimal radial basis construction" href="optimized_radial_basis_functions.html" />
    <link rel="prev" title="A Gaussian approximation potential (GAP) for the Zundel cation" href="zundel_i-PI.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Rascal
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/user_guide.html">User’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="zundel_i-PI.html">A Gaussian approximation potential (GAP) for the Zundel cation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using feature selection to build an efficient potential</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Initialization">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Set-hyperparameters">Set hyperparameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Compute-descriptors">Compute descriptors</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Sample-selection">Sample selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-assessment:-Sparse-samples-only">Model assessment: Sparse samples only</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Now-introduce-feature-selection">Now introduce feature selection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#How-do-we-know-how-many-features-to-select?">How do we know how many features to select?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Model-assessment:-Sparse-samples-and-sparse-features">Model assessment: Sparse samples and sparse features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Timings">Timings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="optimized_radial_basis_functions.html">Optimal radial basis construction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whitepaper.html">Goals &amp; Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SOAP.html">SOAP Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/developer.html">Developer’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rascal</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="examples.html">Examples</a> &raquo;</li>
      <li>Using feature selection to build an efficient potential</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/Feature_selection_example.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Using-feature-selection-to-build-an-efficient-potential">
<h1>Using feature selection to build an efficient potential<a class="headerlink" href="#Using-feature-selection-to-build-an-efficient-potential" title="Permalink to this headline"></a></h1>
<p>In the previous examples (<code class="docutils literal notranslate"><span class="pre">MLIP_example</span></code> and <code class="docutils literal notranslate"><span class="pre">zundel_i-PI</span></code>) we have seen how to use the tools provided by <code class="docutils literal notranslate"><span class="pre">librascal</span></code> in order to build a working potential. We have already used a “sparsification” technique to select a basis set of environments for the fit, as well as to keep the computational cost of both fitting and evaluating the potential manageable.</p>
<p>Now we will introduce a technique to further optimize the computational cost of the model, and it consists of applying the same sparsification technique along the <em>features</em> (columns) of the feature matrix, in addition to the <em>samples</em> (rows). This technique was introduced in Ref. [1] and has since been used in numerous applications. Feature selection and sparse feature computation are both available directly in librascal, and this example aims to show the user how to apply them in a realistic
setting.</p>
<p>A detail on the selection algorithm itself: <code class="docutils literal notranslate"><span class="pre">librascal</span></code> uses the FPS and CUR algorithms implemented in <code class="docutils literal notranslate"><span class="pre">`scikit-cosmo</span></code> &lt;<a class="reference external" href="https://scikit-cosmo.readthedocs.io/en/latest/selection.html">https://scikit-cosmo.readthedocs.io/en/latest/selection.html</a>&gt;`__. You will therefore need to have <code class="docutils literal notranslate"><span class="pre">scikit-cosmo</span></code> installed (<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">skcosmo</span></code>) to run this notebook. Note also that further selection algorithms, notably PCovCUR and PCovFPS, are implemented in <code class="docutils literal notranslate"><span class="pre">skcosmo</span></code> but not yet included directly in <code class="docutils literal notranslate"><span class="pre">librascal</span></code>.</p>
<p>[1]: G. Imbalzano, A. Anelli, D. Giofré, S. Klees, J. Behler, and M. Ceriotti, Automatic Selection of Atomic Fingerprints and Reference Configurations for Machine-Learning Potentials, J. Chem. Phys. 148, 241730 (2018). <a class="reference external" href="https://aip.scitation.org/doi/full/10.1063/1.5024611">doi:10.1063/1.5024611</a></p>
<hr class="docutils" />
<p>Let us begin with the Zundel cation example introduced in the previous notebook:</p>
<section id="Initialization">
<h2>Initialization<a class="headerlink" href="#Initialization" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pylab</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">ase</span>
<span class="kn">from</span> <span class="nn">ase.io</span> <span class="kn">import</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span>
<span class="kn">from</span> <span class="nn">ase.build</span> <span class="kn">import</span> <span class="n">make_supercell</span>
<span class="kn">from</span> <span class="nn">ase.visualize</span> <span class="kn">import</span> <span class="n">view</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># If installed -- not essential, though</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">tqdm</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="c1"># Print some extra information during the selection process</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">rascal.models</span> <span class="kn">import</span> <span class="n">Kernel</span><span class="p">,</span> <span class="n">train_gap_model</span><span class="p">,</span> <span class="n">compute_KNM</span>
<span class="kn">from</span> <span class="nn">rascal.representations</span> <span class="kn">import</span> <span class="n">SphericalInvariants</span>
<span class="kn">from</span> <span class="nn">rascal.utils</span> <span class="kn">import</span> <span class="n">from_dict</span><span class="p">,</span> <span class="n">to_dict</span><span class="p">,</span> <span class="n">CURFilter</span><span class="p">,</span> <span class="n">FPSFilter</span><span class="p">,</span> <span class="n">dump_obj</span><span class="p">,</span> <span class="n">load_obj</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">i</span><span class="o">-</span><span class="n">PI</span><span class="o">/</span><span class="n">zundel</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/Users/Max/Work/codes/librascal/examples/i-PI/zundel
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the first N structures of the zundel dataset</span>
<span class="n">N_dataset</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">frames</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s1">&#39;zundel_dataset.xyz&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N_dataset</span><span class="p">))</span>
<span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;zundel_energies.txt&#39;</span><span class="p">)[:</span><span class="n">N_dataset</span><span class="p">]</span>
<span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">frame</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forces</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(7000, 3)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of structures to train the model with</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="mi">800</span>

<span class="n">global_species</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>

<span class="c1"># Select randomly n structures for training the model</span>
<span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_dataset</span><span class="p">))</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

<span class="n">train_ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
<span class="n">frames_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">frames</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]]</span>
<span class="n">e_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">energies</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]])</span>
<span class="n">f_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">frame</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_train</span><span class="p">])</span>
<span class="c1"># Test on the remaining 200 molecules</span>
<span class="n">test_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]]</span>
<span class="n">frames_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">frames</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">test_ids</span><span class="p">]</span>
<span class="n">e_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">energies</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">test_ids</span><span class="p">])</span>
<span class="n">f_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">frame</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_test</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Set-hyperparameters">
<h2>Set hyperparameters<a class="headerlink" href="#Set-hyperparameters" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Atomic energy baseline - assuming all configurations have the same number of atoms</span>
<span class="n">atom_energy_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">energy_baseline</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">species</span><span class="p">):</span> <span class="n">atom_energy_baseline</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">global_species</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the parameters of the spherical expansion</span>
<span class="n">hypers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">soap_type</span><span class="o">=</span><span class="s2">&quot;PowerSpectrum&quot;</span><span class="p">,</span>
              <span class="n">interaction_cutoff</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
              <span class="n">max_radial</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
              <span class="n">max_angular</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
              <span class="n">gaussian_sigma_constant</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
              <span class="n">gaussian_sigma_type</span><span class="o">=</span><span class="s2">&quot;Constant&quot;</span><span class="p">,</span>
              <span class="n">cutoff_function_type</span><span class="o">=</span><span class="s2">&quot;RadialScaling&quot;</span><span class="p">,</span>
              <span class="n">cutoff_smooth_width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
              <span class="n">cutoff_function_parameters</span><span class="o">=</span>
                    <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">scale</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
                            <span class="n">exponent</span><span class="o">=</span><span class="mi">4</span>
                        <span class="p">),</span>
              <span class="n">radial_basis</span><span class="o">=</span><span class="s2">&quot;GTO&quot;</span><span class="p">,</span>
              <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">optimization</span><span class="o">=</span>
                    <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">Spline</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                               <span class="n">accuracy</span><span class="o">=</span><span class="mf">1.0e-05</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
              <span class="n">compute_gradients</span><span class="o">=</span><span class="kc">False</span>
              <span class="p">)</span>


<span class="n">soap</span> <span class="o">=</span> <span class="n">SphericalInvariants</span><span class="p">(</span><span class="o">**</span><span class="n">hypers</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Compute-descriptors">
<h2>Compute descriptors<a class="headerlink" href="#Compute-descriptors" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">managers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames_train</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-18</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">managers</span> <span class="o">=</span> <span class="n">soap</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">frames_train</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Execution: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Execution:  0.30106329917907715 s
</pre></div></div>
</div>
</section>
<section id="Sample-selection">
<h2>Sample selection<a class="headerlink" href="#Sample-selection" title="Permalink to this headline"></a></h2>
<p>Now we select the set of sparse <em>samples</em> (environments). In effect, we are selecting an optimally diverse set of <em>rows</em> of the feature matrix <span class="math notranslate nohighlight">\(X\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select the sparse points for the sparse kernel method with FPS on the whole training set</span>
<span class="n">n_sparse_env</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span>
<span class="n">sample_compressor</span> <span class="o">=</span> <span class="n">FPSFilter</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">n_sparse_env</span><span class="p">,</span> <span class="n">act_on</span><span class="o">=</span><span class="s1">&#39;sample per species&#39;</span><span class="p">)</span>
<span class="n">X_sparse</span> <span class="o">=</span> <span class="n">sample_compressor</span><span class="o">.</span><span class="n">select_and_filter</span><span class="p">(</span><span class="n">managers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:rascal.utils.filter:The number of pseudo points selected by central atom species is: {1: 50, 8: 100}
INFO:rascal.utils.filter:Selecting species: 1
INFO:rascal.utils.filter:Selecting species: 8
</pre></div></div>
</div>
</section>
<section id="Model-assessment:-Sparse-samples-only">
<h2>Model assessment: Sparse samples only<a class="headerlink" href="#Model-assessment:-Sparse-samples-only" title="Permalink to this headline"></a></h2>
<p>Let’s build our potential and get some benchmarks.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zeta</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">hypers</span><span class="p">[</span><span class="s1">&#39;compute_gradients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">soap_grads</span> <span class="o">=</span> <span class="n">SphericalInvariants</span><span class="p">(</span><span class="o">**</span><span class="n">hypers</span><span class="p">)</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">Kernel</span><span class="p">(</span><span class="n">soap_grads</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GAP&#39;</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="n">zeta</span><span class="p">,</span> <span class="n">target_type</span><span class="o">=</span><span class="s1">&#39;Structure&#39;</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;Sparse&#39;</span><span class="p">)</span>

<span class="n">KNM</span> <span class="o">=</span> <span class="n">compute_KNM</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">frames_train</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing kernel matrix&quot;</span><span class="p">),</span> <span class="n">X_sparse</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">soap_grads</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">train_gap_model</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">frames_train</span><span class="p">,</span> <span class="n">KNM</span><span class="p">,</span> <span class="n">X_sparse</span><span class="p">,</span> <span class="n">e_train</span><span class="p">,</span> <span class="n">energy_baseline</span><span class="p">,</span>
                        <span class="n">grad_train</span><span class="o">=-</span><span class="n">f_train</span><span class="p">,</span> <span class="n">lambdas</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">],</span> <span class="n">jitter</span><span class="o">=</span><span class="mf">1e-13</span><span class="p">)</span>

<span class="c1"># save the model to a file in json format for future use</span>
<span class="n">dump_obj</span><span class="p">(</span><span class="s1">&#39;zundel_model.json&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;Structure_indices.txt&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Execution: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Execution:  4.386488199234009 s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make predictions on the test set</span>
<span class="n">e_pred</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">f_pred</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">frames_test</span><span class="p">):</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-18</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">soap_grads</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">e_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict_forces</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

<span class="n">e_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_pred</span><span class="p">)</span>
<span class="n">f_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">f_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rascal.utils</span> <span class="kn">import</span> <span class="n">get_score</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">get_score</span><span class="p">(</span><span class="n">e_pred</span><span class="p">,</span> <span class="n">e_test</span><span class="p">)</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span>
<span class="n">sigma_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">e_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RMSE = &quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">,</span> <span class="s2">&quot;meV&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set stdev = &quot;</span><span class="p">,</span> <span class="n">sigma_test</span><span class="p">,</span> <span class="s2">&quot; eV&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Relative RMSE = &quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">/</span><span class="n">sigma_test</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span> <span class="s2">&quot; %&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RMSE =  37.27416992356848 meV
Test set stdev =  0.274800153468654  eV
Relative RMSE =  13.564100839492538  %
</pre></div></div>
</div>
</section>
<section id="Now-introduce-feature-selection">
<h2>Now introduce feature selection<a class="headerlink" href="#Now-introduce-feature-selection" title="Permalink to this headline"></a></h2>
<p>This potential uses quite a large number of features to make its predictions:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">soap</span><span class="o">.</span><span class="n">get_num_coefficients</span><span class="p">(</span><span class="n">n_species</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1344
</pre></div></div>
</div>
<p>Since the cost to compute the kernel (and hence evaluate the model) scales asymptotically linearly with the number of features [2], it would be nice if we could get away with using fewer components of the feature vector.</p>
<p>[2]: F. Musil, M. Veit, A. Goscinski, G. Fraux, M. J. Willatt, M. Stricker, T. Junge, and M. Ceriotti, Efficient Implementation of Atom-Density Representations, J. Chem. Phys. 154, 114109 (2021). <a class="reference external" href="https://aip.scitation.org/doi/10.1063/5.0044689">doi:10.1063/5.0044689</a></p>
<p>To select features (columns) instead of samples (rows), we use the same selector class as above with a few changes. Let’s start with a conservative estimate of half the total number of features:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select the features with FPS, again the whole training set</span>
<span class="n">n_sparse_feat</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">feat_compressor</span> <span class="o">=</span> <span class="n">FPSFilter</span><span class="p">(</span><span class="n">soap</span><span class="p">,</span> <span class="n">n_sparse_feat</span><span class="p">,</span> <span class="n">act_on</span><span class="o">=</span><span class="s1">&#39;feature&#39;</span><span class="p">)</span>
<span class="n">feat_sparse_parameters</span> <span class="o">=</span> <span class="n">feat_compressor</span><span class="o">.</span><span class="n">select_and_filter</span><span class="p">(</span><span class="n">managers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that here we use the full feature matrix again, but in real scientific applications this might not be possible or practical due to the size of the full matrix. In this case we might sub-select samples, either randomly or using our existing sparse sample selection*, to obtain a smaller matrix to work with.</p>
<p>*You might be wondering how we do the sparse sample selection in the first place if the full feature matrix is too big to fit in memory. There are various ways around this, including iterative or hierarchical selection methods, or we could just do feature selection first on a random subset and then do sample selection on the feature-sparsified matrix. The best method to use will in general depend on the application and is out of the scope of this tutorial.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat_sparse_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([&#39;coefficient_subselection&#39;, &#39;selected_feature_ids_global&#39;, &#39;selected_feature_ids_global_selection_ordering&#39;])
</pre></div></div>
</div>
<p>The result is a dictionary that tells the <code class="docutils literal notranslate"><span class="pre">SphericalInvariants</span></code> class which coefficents to compute. In order to use it, we must update the <code class="docutils literal notranslate"><span class="pre">hypers</span></code> and create a new, sparsified version of the <code class="docutils literal notranslate"><span class="pre">soap</span></code> feature calculator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hypers</span><span class="p">[</span><span class="s1">&#39;coefficient_subselection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat_sparse_parameters</span><span class="p">[</span><span class="s1">&#39;coefficient_subselection&#39;</span><span class="p">]</span>
<span class="n">soap_fsparse</span> <span class="o">=</span> <span class="n">SphericalInvariants</span><span class="p">(</span><span class="o">**</span><span class="n">hypers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">managers_sparsefeat</span> <span class="o">=</span> <span class="n">soap_fsparse</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">frames_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution time: </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Execution time: 1.7077140808105469 s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bit of a hack because we can&#39;t directly use the old `sample_compressor` on the new features</span>
<span class="n">sample_compressor_sparse</span> <span class="o">=</span> <span class="n">FPSFilter</span><span class="p">(</span><span class="n">soap_fsparse</span><span class="p">,</span> <span class="n">n_sparse_env</span><span class="p">,</span> <span class="n">act_on</span><span class="o">=</span><span class="s1">&#39;sample per species&#39;</span><span class="p">)</span>
<span class="n">sample_compressor_sparse</span><span class="o">.</span><span class="n">selected_sample_ids_by_sp</span> <span class="o">=</span> <span class="n">sample_compressor</span><span class="o">.</span><span class="n">selected_sample_ids_by_sp</span>
<span class="n">X_sparse_sparsefeat</span> <span class="o">=</span> <span class="n">sample_compressor_sparse</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">managers_sparsefeat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="How-do-we-know-how-many-features-to-select?">
<h3>How do we know how many features to select?<a class="headerlink" href="#How-do-we-know-how-many-features-to-select?" title="Permalink to this headline"></a></h3>
<p>With FPS, one metric we can look at to get a rough estimate of the required number of features is the Hausdorff distance of each selected point (basically, the distance of the selected point to the closest point in the “blob” of already-selected points). This tells us how far (in feature space) each selected point is from the selected set, and <em>very</em> roughly, the amount of diversity it adds to the set. So when the decrease in this distance starts to slow down, it indicates that we are getting
less of an information return for each point added to the set.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fps_dists</span> <span class="o">=</span> <span class="n">feat_compressor</span><span class="o">.</span><span class="n">get_fps_distances</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">fps_dists</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Selected feature index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Hausdorff distance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;FPS selection on features&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;FPS selection on features&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_Feature_selection_example_36_1.png" src="../_images/examples_Feature_selection_example_36_1.png" />
</div>
</div>
<p>From this plot, it seems that we might even be able to get away with 200 or 300 features, but we should test this more rigorously. What we really care about is how well these sparsified features reproduce the <em>kernel</em> – so let’s look at the difference in the kernel between the sparse <em>environments</em>, with and without <em>feature</em> sparsification.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">K_MM_fullfeat</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">(</span><span class="n">X_sparse</span><span class="p">)</span>
<span class="n">kernel_sparsefeat</span> <span class="o">=</span> <span class="n">Kernel</span><span class="p">(</span><span class="n">soap_fsparse</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GAP&#39;</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="n">zeta</span><span class="p">,</span> <span class="n">target_type</span><span class="o">=</span><span class="s1">&#39;Structure&#39;</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;Sparse&#39;</span><span class="p">)</span>
<span class="n">K_MM_sparsefeat</span> <span class="o">=</span> <span class="n">kernel_sparsefeat</span><span class="p">(</span><span class="n">X_sparse_sparsefeat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">K_MM_fullfeat</span> <span class="o">-</span> <span class="n">K_MM_sparsefeat</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.7171404793446092
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">K_MM_fullfeat</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
104.82383972597799
</pre></div></div>
</div>
<p>So the difference in the norms is less than 1% of the norm of the kernel matrix. Let’s see if we can use an even smaller number of features:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_feature_sparsified_soap</span><span class="p">(</span><span class="n">Nselect</span><span class="p">,</span> <span class="n">full_soap</span><span class="p">,</span> <span class="n">managers</span><span class="p">,</span> <span class="n">sample_compressor</span><span class="p">):</span>
    <span class="n">feat_compressor</span> <span class="o">=</span> <span class="n">FPSFilter</span><span class="p">(</span><span class="n">full_soap</span><span class="p">,</span> <span class="n">Nselect</span><span class="p">,</span> <span class="n">act_on</span><span class="o">=</span><span class="s1">&#39;feature&#39;</span><span class="p">)</span>
    <span class="n">feat_sparse_parameters</span> <span class="o">=</span> <span class="n">feat_compressor</span><span class="o">.</span><span class="n">select_and_filter</span><span class="p">(</span><span class="n">managers</span><span class="p">)</span>
    <span class="n">soap_hypers</span> <span class="o">=</span> <span class="n">full_soap</span><span class="o">.</span><span class="n">_get_init_params</span><span class="p">()</span>
    <span class="n">soap_hypers</span><span class="p">[</span><span class="s1">&#39;coefficient_subselection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat_sparse_parameters</span><span class="p">[</span><span class="s1">&#39;coefficient_subselection&#39;</span><span class="p">]</span>
    <span class="n">soap_fsparse</span> <span class="o">=</span> <span class="n">SphericalInvariants</span><span class="p">(</span><span class="o">**</span><span class="n">soap_hypers</span><span class="p">)</span>
    <span class="n">managers_sparsefeat</span> <span class="o">=</span> <span class="n">soap_fsparse</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">managers</span><span class="p">)</span>
    <span class="n">sample_compressor_sparse</span> <span class="o">=</span> <span class="n">FPSFilter</span><span class="p">(</span><span class="n">soap_fsparse</span><span class="p">,</span> <span class="n">n_sparse_env</span><span class="p">,</span> <span class="n">act_on</span><span class="o">=</span><span class="s1">&#39;sample per species&#39;</span><span class="p">)</span>
    <span class="n">sample_compressor_sparse</span><span class="o">.</span><span class="n">selected_sample_ids_by_sp</span> <span class="o">=</span> <span class="n">sample_compressor</span><span class="o">.</span><span class="n">selected_sample_ids_by_sp</span>
    <span class="n">X_sparse_sparsefeat</span> <span class="o">=</span> <span class="n">sample_compressor_sparse</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">managers_sparsefeat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">soap_fsparse</span><span class="p">,</span> <span class="n">managers_sparsefeat</span><span class="p">,</span> <span class="n">X_sparse_sparsefeat</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">soap_smallsparse</span><span class="p">,</span> <span class="n">managers_sparsefeat</span><span class="p">,</span> <span class="n">X_sparse_sparsefeat</span> <span class="o">=</span> <span class="n">get_feature_sparsified_soap</span><span class="p">(</span>
    <span class="mi">200</span><span class="p">,</span> <span class="n">soap</span><span class="p">,</span> <span class="n">managers</span><span class="p">,</span> <span class="n">sample_compressor</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel_sparsefeat</span> <span class="o">=</span> <span class="n">Kernel</span><span class="p">(</span><span class="n">soap_smallsparse</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GAP&#39;</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="n">zeta</span><span class="p">,</span> <span class="n">target_type</span><span class="o">=</span><span class="s1">&#39;Structure&#39;</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;Sparse&#39;</span><span class="p">)</span>
<span class="n">K_MM_sparsefeat</span> <span class="o">=</span> <span class="n">kernel_sparsefeat</span><span class="p">(</span><span class="n">X_sparse_sparsefeat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">K_MM_fullfeat</span> <span class="o">-</span> <span class="n">K_MM_sparsefeat</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.8514895312542564
</pre></div></div>
</div>
<p>Barely a difference. So let’s proceed with 200 features and see how accurate our model is:</p>
</section>
</section>
<section id="Model-assessment:-Sparse-samples-and-sparse-features">
<h2>Model assessment: Sparse samples and sparse features<a class="headerlink" href="#Model-assessment:-Sparse-samples-and-sparse-features" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zeta</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">sparse_hypers</span> <span class="o">=</span> <span class="n">soap_smallsparse</span><span class="o">.</span><span class="n">_get_init_params</span><span class="p">()</span>
<span class="n">sparse_hypers</span><span class="p">[</span><span class="s1">&#39;compute_gradients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">soap_fsparse_grads</span> <span class="o">=</span> <span class="n">SphericalInvariants</span><span class="p">(</span><span class="o">**</span><span class="n">sparse_hypers</span><span class="p">)</span>
<span class="n">kernel_fsparse</span> <span class="o">=</span> <span class="n">Kernel</span><span class="p">(</span><span class="n">soap_fsparse_grads</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GAP&#39;</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="n">zeta</span><span class="p">,</span> <span class="n">target_type</span><span class="o">=</span><span class="s1">&#39;Structure&#39;</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;Sparse&#39;</span><span class="p">)</span>

<span class="n">KNM</span> <span class="o">=</span> <span class="n">compute_KNM</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">frames_train</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing kernel matrix&quot;</span><span class="p">),</span> <span class="n">X_sparse_sparsefeat</span><span class="p">,</span> <span class="n">kernel_fsparse</span><span class="p">,</span> <span class="n">soap_fsparse_grads</span><span class="p">)</span>

<span class="n">model_fsparse</span> <span class="o">=</span> <span class="n">train_gap_model</span><span class="p">(</span>
    <span class="n">kernel_fsparse</span><span class="p">,</span>
    <span class="n">frames_train</span><span class="p">,</span>
    <span class="n">KNM</span><span class="p">,</span>
    <span class="n">X_sparse_sparsefeat</span><span class="p">,</span>
    <span class="n">e_train</span><span class="p">,</span>
    <span class="n">energy_baseline</span><span class="p">,</span>
    <span class="n">grad_train</span><span class="o">=-</span><span class="n">f_train</span><span class="p">,</span>
    <span class="n">lambdas</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">],</span>
    <span class="n">jitter</span><span class="o">=</span><span class="mf">1e-13</span>
<span class="p">)</span>

<span class="c1"># save the model to a file in json format for future use</span>
<span class="n">dump_obj</span><span class="p">(</span><span class="s1">&#39;zundel_model_featsparse.json&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;Structure_indices.txt&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Execution: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Execution:  1.8869318962097168 s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make predictions on the test set</span>
<span class="n">e_pred</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">f_pred</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">frames_test</span><span class="p">):</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-18</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">soap_fsparse_grads</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">e_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_fsparse</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">f_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_fsparse</span><span class="o">.</span><span class="n">predict_forces</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

<span class="n">e_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_pred</span><span class="p">)</span>
<span class="n">f_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">f_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Notice how it is already much faster to train and evaluate a model. Now, how accurate is it?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rascal.utils</span> <span class="kn">import</span> <span class="n">get_score</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">get_score</span><span class="p">(</span><span class="n">e_pred</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">e_test</span><span class="p">)</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span>
<span class="n">sigma_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">e_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RMSE = &quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">,</span> <span class="s2">&quot;meV&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set stdev = &quot;</span><span class="p">,</span> <span class="n">sigma_test</span><span class="p">,</span> <span class="s2">&quot; eV&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Relative RMSE = &quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">/</span><span class="n">sigma_test</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span> <span class="s2">&quot; %&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RMSE =  26.000018450459176 meV
Test set stdev =  0.274800153468654  eV
Relative RMSE =  9.461427922173616  %
</pre></div></div>
</div>
<p>In fact, it’s slightly <em>more</em> accurate than the model built with the full feature set. This might be because the model built with the full features overfits slightly, since it has more than enough features to describe the dataset. If we were to optimize the regularizers for both these fits, it is likely that the feature-sparsified model would have approximately equal or lower accuracy than the full model.</p>
</section>
<section id="Timings">
<h2>Timings<a class="headerlink" href="#Timings" title="Permalink to this headline"></a></h2>
<p>Now, back to our main motivation for doing feature sparsification. If we use these models to run molecular dynamics (MD), how much of a speedup do we get with the feature-sparsified model?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ase.md</span> <span class="kn">import</span> <span class="n">MDLogger</span>
<span class="kn">from</span> <span class="nn">ase.md.langevin</span> <span class="kn">import</span> <span class="n">Langevin</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">ase.io.trajectory</span> <span class="kn">import</span> <span class="n">Trajectory</span>
<span class="kn">from</span> <span class="nn">ase.md.velocitydistribution</span> <span class="kn">import</span> <span class="n">MaxwellBoltzmannDistribution</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rascal.models.asemd</span> <span class="kn">import</span> <span class="n">ASEMLCalculator</span>
</pre></div>
</div>
</div>
<p>Let’s use the ASE calculator (as in <code class="docutils literal notranslate"><span class="pre">MLIP_example.ipynb</span></code>), which we can run directly in the notebook.</p>
<p>Full model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">atoms</span> <span class="o">=</span> <span class="n">frames_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">ASEMLCalculator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">soap_grads</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

<span class="n">MaxwellBoltzmannDistribution</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">T</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kB</span><span class="p">)</span>
<span class="n">atoms</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span>
<span class="n">dyn</span> <span class="o">=</span> <span class="n">Langevin</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">)</span>
<span class="n">dyn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: </span><span class="si">{}</span><span class="s2"> s (</span><span class="si">{}</span><span class="s2"> ms per timestep)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">/</span> <span class="mi">500</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Elapsed time: 2.3851280212402344 s (4.770256042480469 ms per timestep)
</pre></div></div>
</div>
<p>Feature-sparsified model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">atoms</span> <span class="o">=</span> <span class="n">frames_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">ASEMLCalculator</span><span class="p">(</span><span class="n">model_fsparse</span><span class="p">,</span> <span class="n">soap_fsparse_grads</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

<span class="n">MaxwellBoltzmannDistribution</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">T</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kB</span><span class="p">)</span>
<span class="n">atoms</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span>
<span class="n">dyn</span> <span class="o">=</span> <span class="n">Langevin</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">)</span>
<span class="n">dyn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: </span><span class="si">{}</span><span class="s2"> s (</span><span class="si">{}</span><span class="s2"> ms per timestep)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">/</span> <span class="mi">500</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Elapsed time: 1.2145779132843018 s (2.4291558265686035 ms per timestep)
</pre></div></div>
</div>
<p>So our feature-sparsified model is about twice as fast as the full model, and with the same accuracy!</p>
<p>(But since we selected about one-sixth of the features, why isn’t it 6x as fast? Well, there are various overheads, especially in the computation of gradients that are needed for MD forces, that keep the computational cost from scaling exactly linearly with the feature vector size. We could probably push the cost down even further by optimizing the feature size more aggressively, but if we want to keep the same accuracy we probably won’t be able to get a speedup above about 3x. Note also that
the impact of this optimization is much more pronounced for models with much larger feature sizes – e.g. many atomic species or high <code class="docutils literal notranslate"><span class="pre">max_radial</span></code>/<code class="docutils literal notranslate"><span class="pre">max_angular</span></code> parameters.)</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="zundel_i-PI.html" class="btn btn-neutral float-left" title="A Gaussian approximation potential (GAP) for the Zundel cation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="optimized_radial_basis_functions.html" class="btn btn-neutral float-right" title="Optimal radial basis construction" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Chiheb Ben Mahmoud, Michele Ceriotti, Federico Giberti,
Klim Goldshtein, Till Junge, Markus Stricker, Félix Musil, Max Veit.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>